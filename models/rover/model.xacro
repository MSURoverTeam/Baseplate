<?xml version='1.0'?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name='rover'>

  <gazebo>
    <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
      <robotNamespace>/rover</robotNamespace>
    </plugin>
  </gazebo>

  <static>0</static>
  <allow_auto_disable>1</allow_auto_disable>

  <xacro:macro name="transmission" params="idx">
        <transmission name="trans_${idx}">
          <type>transmission_interface/SimpleTransmission</type>
          <joint name="wheel_${idx}_joint">
            <hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
          </joint>
          <actuator name="motor_${idx}">
            <mechanicalReduction>1</mechanicalReduction>
            <hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
          </actuator>
        </transmission>
  </xacro:macro>

  <xacro:macro
  name="link_defaults"
  params="self_col:=0 wind:=0 kinematic:=0 gravity:=1">
    <gravity>${gravity}</gravity>
    <self_collide>${self_col}</self_collide>
    <kinematic>${kinematic}</kinematic>
    <enable_wind>${wind}</enable_wind>
  </xacro:macro>

  <xacro:macro
  name="visual_defaults"
  params="transp:=0 shadows:=1">
    <transparency>${transp}</transparency>
    <cast_shadows>${shadows}</cast_shadows>
  </xacro:macro>

  <xacro:macro
  name="collision_defaults"
  params="laser_retro:=0 contacts:=10">
    <laser_retro>${laser_retro}</laser_retro>
    <max_contacts>${contacts}</max_contacts>
  </xacro:macro>

  <xacro:macro name="joint_from_to" params="fr to">
    <parent link="${fr}"/>
    <child link="${to}"/>
  </xacro:macro>

  <xacro:macro name="mesh" params="path">
    <mesh filename="${path}" scale="1 1 1" />
  </xacro:macro>

  <xacro:macro
  name="wheel"
  params="idx pos connect:=boggie">
    <xacro:property name="side" value="${'right' if idx in [1,2,3] else 'left'}"/>
    <link name='wheel_${idx}'>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertial>
        <mass value="1"/>
        <inertia ixx="0.013"  ixy="0"  ixz="0" iyy="0.013" iyz="0" izz="0.024"/>
      </inertial>
      <visual name='visual'>
        <origin xyz="0 0 0.034" rpy="0 0 0"/>
        <geometry>
          <xacro:mesh path="file:///opt/rover/meshes/rover/wheel.stl"/>
        </geometry>
        <xacro:visual_defaults/>
      </visual>
      <collision name='wheel_${idx}_collision'>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <xacro:collision_defaults/>
        <geometry>
          <cylinder length="0.072" radius="0.128" />
        </geometry>
      </collision>
      <xacro:link_defaults/>
    </link>
    <joint name='wheel_${idx}_joint' type='continuous'>
      <xacro:joint_from_to fr="${side}_${connect}" to="wheel_${idx}"/>
      <xacro:if value="${side == 'right'}">
        <axis xyz="0 0 -1"/>
      </xacro:if>
      <xacro:if value="${side == 'left'}">
        <axis xyz="0 0 1"/>
      </xacro:if>
      <origin xyz="${pos}" rpy="${'0 0 0' if side == 'right' else '3.1414 0 0'}"/>
    </joint>
  </xacro:macro>

  <link name='base_link'>
    <xacro:link_defaults/>
    <visual name='visual'>
      <origin xyz="0 0 0" rpy="1.5707 0 0"/>
      <geometry>
        <xacro:mesh path="file:///opt/rover/meshes/rover/joint1_box.stl"/>
      </geometry>
      <xacro:visual_defaults/>
    </visual>
    <collision name='chassis_collision'>
      <origin xyz="-0.07 0 -0.02" rpy="0 0 0"/>
      <xacro:collision_defaults/>
      <geometry>
        <box size="0.686 0.466 0.2264"/>
      </geometry>
    </collision>
  </link>

  <link name="chassis_inertial">
    <gravity>1</gravity>
    <inertial>
        <inertia ixx="0.242"  ixy="-0.002"  ixz="0" iyy="0.49" iyz="0" izz="0.348" />
        <mass value="20"/>
      </inertial>
  </link>
  <joint name='chassis_inertial_fix' type='fixed'>
    <xacro:joint_from_to fr="base_link" to="chassis_inertial"/>
  </joint>

  <link name='left_handle'>
    <origin xyz="0 0.290 0" rpy="0 0 0"/>
    <inertial>
      <mass value="2.209"/>
      <inertia ixx="0.031"  ixy="0.027"  ixz="-0.001" iyy="0.073" iyz="-0.002" izz="0.099" />
    </inertial>
    <visual name='visual'>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <xacro:mesh path="file:///opt/rover/meshes/rover/joint2L.stl"/>
      </geometry>
      <xacro:visual_defaults/>
    </visual>
    <xacro:link_defaults/>
  </link>
  <joint name='left_handle_joint' type='revolute'>
    <xacro:joint_from_to fr="base_link" to="left_handle"/>
    <axis xyz="0 0 1"/>
    <origin xyz="0 0.290 0" rpy="1.5707 0 0"/>
    <limit effort="1000.0" lower="-0.524" upper="0.524" velocity="1.5707"/>
  </joint>

  <link name='right_handle'>
    <origin xyz="0 -0.290 0" rpy="0 0 0"/>
    <inertial>
      <mass value="2.209"/>
      <inertia ixx="0.031"  ixy="0.027"  ixz="-0.001" iyy="0.073" iyz="0.002" izz="0.099" />
    </inertial>
    <visual name='visual'>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <xacro:mesh path="file:///opt/rover/meshes/rover/joint2R.stl"/>
      </geometry>
      <xacro:visual_defaults/>
    </visual>
    <xacro:link_defaults/>
  </link>
  <joint name='right_handle_joint' type='revolute'>
    <xacro:joint_from_to fr="base_link" to="right_handle"/>
    <axis xyz="0 0 1"/>
    <origin xyz="0 -0.290 0" rpy="1.5707 0 0"/>
    <limit effort="1000.0" lower="-0.524" upper="0.524" velocity="1.5707"/>
  </joint>

  <link name='right_boggie'>
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <inertial>
      <mass value="1.699"/>
      <inertia ixx="0.024"  ixy="0"  ixz="0" iyy="0.32" iyz="0.004" izz="0.05"/>
    </inertial>
    <visual name='visual'>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <xacro:mesh path="file:///opt/rover/meshes/rover/joint3.stl"/>
      </geometry>
      <xacro:visual_defaults/>
    </visual>
    <xacro:link_defaults/>
  </link>
  <joint name='right_boggie_joint' type='revolute'>
    <xacro:joint_from_to fr="right_handle" to="right_boggie"/>
    <axis xyz="0 0 1"/>
    <origin xyz="-0.239726 -0.07490 -0.006" rpy="0 0 0"/>
    <limit effort="1000.0" lower="-0.524" upper="0.524" velocity="1.5707"/>
  </joint>

  <link name='left_boggie'>
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <inertial>
      <mass value="1.699"/>
      <inertia ixx="0.024"  ixy="0"  ixz="0" iyy="0.32" iyz="0.004" izz="0.05"/>
    </inertial>
    <visual name='visual'>
      <origin xyz="0 0 0" rpy="0 3.14159 0"/>
      <geometry>
        <xacro:mesh path="file:///opt/rover/meshes/rover/joint3.stl"/>
      </geometry>
      <xacro:visual_defaults/>
    </visual>
    <xacro:link_defaults/>
  </link>
  <joint name='left_boggie_joint' type='revolute'>
    <xacro:joint_from_to fr="left_handle" to="left_boggie"/>
    <axis xyz="0 0 1"/>
    <origin xyz="-0.239726 -0.07490 0.006" rpy="0 0 0"/>
    <limit effort="1000.0" lower="-0.524" upper="0.524" velocity="1.5707"/>
  </joint>

  <link name='differential'>
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <inertial>
      <mass value="2.7"/>
      <inertia ixx="0.012"  ixy="0"  ixz="0" iyy="0.012" iyz="0" izz="0"/>
    </inertial>
    <visual name='visual'>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <xacro:mesh path="file:///opt/rover/meshes/rover/joint4-diff.stl"/>
      </geometry>
      <xacro:visual_defaults/>
    </visual>
    <xacro:link_defaults/>
  </link>
  <joint name='differential_joint' type='continuous'>
    <xacro:joint_from_to fr="base_link" to="differential"/>
    <axis xyz="0 1 0"/>
    <origin xyz="-0.230 0 0.128" rpy="1.5707 0 0"/>
  </joint>

  <xacro:wheel idx="1" pos="0.264321 -0.213856 0.132" connect="handle"/>
  <xacro:wheel idx="6" pos="0.264321 -0.213856  -0.132" connect="handle"/>
  <xacro:wheel idx="2" pos="0.167 -0.14  0.138"/>
  <xacro:wheel idx="5" pos="0.167 -0.14  -0.138"/>
  <xacro:wheel idx="3" pos="-0.167 -0.14  0.138"/>
  <xacro:wheel idx="4" pos="-0.167 -0.14  -0.138"/>

  <xacro:include filename="/opt/rover/rover/differential.xacro" />

  <xacro:transmission idx="1"/>
  <xacro:transmission idx="6"/>

  <xacro:transmission idx="2"/>
  <xacro:transmission idx="4"/>

  <xacro:transmission idx="3"/>
  <xacro:transmission idx="5"/>
</robot>
